dashboards:
  RLS:
    dependsOn:
      datasets:
      - rls_dataset
      - rls_all_users_view
    name: RLS
    dashboardId: cid-rls
    category: Advanced
    version: v0.0.1
    file: ./rls-definition.yaml
    theme: MIDNIGHT
datasets:
  rls_dataset:
    data:
      DataSetId: 770b6f30-9498-49e2-9878-5ac9e3258b2c
      Name: rls_dataset
      PhysicalTableMap:
        625fab9d-ce94-4690-a7bf-142b0996ddda:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: rls_dataset
            InputColumns:
            - Name: UserName
              Type: STRING
            - Name: GroupName
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: payer_id
              Type: STRING
      LogicalTableMap:
        ba97c5ca-ff05-4d15-8cca-ffd0b8e3d804:
          Alias: rls_dataset
          Source:
            PhysicalTableId: 625fab9d-ce94-4690-a7bf-142b0996ddda
      ImportMode: SPICE
      UseAs: RLS_RULES
    dependsOn:
      views:
      - rls_dataset
    schedules:
    - default
  rls_all_users_view:
    data:
      DataSetId: 0414c907-daaf-46f7-9ae4-f922c198faa4
      Name: rls_all_users_view
      PhysicalTableMap:
        a4a17683-2fe9-4d08-9935-95ed1af884bb:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: rls_all_users_view
            InputColumns:
            - Name: email
              Type: STRING
            - Name: username
              Type: STRING
            - Name: groupname
              Type: STRING
            - Name: account_id
              Type: STRING
            - Name: payer_id
              Type: STRING
            - Name: permission_type
              Type: STRING
      LogicalTableMap:
        3ed793b5-9318-41ff-b172-e762a9967ec0:
          Alias: rls_all_users_view
          Source:
            PhysicalTableId: a4a17683-2fe9-4d08-9935-95ed1af884bb
      ImportMode: SPICE
    dependsOn:
      views:
      - rls_all_users_view
    schedules:
    - default
crawlers: {}
views:
  rls_dataset:
    dependsOn:
      views:
      - rls_all_permissions
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".rls_dataset AS
      SELECT
        qs.username as "UserName"
      , rls."group" as "GroupName"
      , rls.account_ids account_id
      , rls.payer_ids payer_id
      FROM
        (rls_all_permissions rls
      LEFT JOIN "${data_collection_database_name}".quicksight_user_data qs ON (qs.email = rls.email))
    parameters:
      data_collection_database_name:
        type: athena
        query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'quicksight_user_data'
        error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
        default: optimization_data
        description: "Enter the name of the data collection database"
        global: True
  rls_all_permissions:
    dependsOn:
      views:
      - rls_account_permissions
      - rls_org_view
      - rls_full_access_users
      - rls_full_access_groups
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".rls_all_permissions AS
      WITH
        rls_account_permissions_per_email AS (
         SELECT
           email
         , '' "group"
         , account_id
         , '' payer_id
         FROM
           (rls_org_view
         CROSS JOIN UNNEST(emails) t (email))
      )
      , rls_management_account_permissions_per_email AS (
         SELECT
           email
         , '' "group"
         , '' account_id
         , account_id payer_id
         FROM
           (rls_org_view
         CROSS JOIN UNNEST(emails) t (email))
         WHERE (account_id = payer_id)
      )
      , rls_full_access_per_email AS (
         SELECT
           email
         , '' "group"
         , '' account_id
         , '' payer_id
         FROM
           rls_full_access_users
      )
      , rls_account_permissions_per_group AS (
         SELECT
           '' email
         , "group"
         , account_id
         , '' payer_id
         FROM
           (rls_org_view
         CROSS JOIN UNNEST("groups") t ("group"))
      )
      , rls_management_account_permissions_per_group AS (
         SELECT
           '' email
         , "group"
         , '' account_id
         , account_id payer_id
         FROM
           (rls_org_view
         CROSS JOIN UNNEST("groups") t ("group"))
         WHERE (account_id = payer_id)

      )
      , rls_full_access_per_group AS (
         SELECT
           "group"
         , '' account_id
         , '' payer_id
         FROM
           rls_full_access_groups
      )

      SELECT
        email
      , "group"
      , ARRAY_JOIN(ARRAY_AGG(account_id) FILTER (WHERE ((account_id IS NOT NULL) AND (account_id <> ''))), ',') account_ids
      , ARRAY_JOIN(ARRAY_AGG(payer_id) FILTER (WHERE ((payer_id IS NOT NULL) AND (payer_id <> ''))), ',') payer_ids
      FROM
        (
         SELECT
           email
         , '' "group"
         , account_id
         , payer_id
         FROM
           rls_account_permissions_per_email
         WHERE ((NOT (email IN (SELECT email
      FROM
        rls_management_account_permissions_per_email
      ))) AND (NOT (email IN (SELECT email
      FROM
        rls_full_access_per_email
      ))))

      UNION ALL

      SELECT
           email
         , '' "group"
         , account_id
         , payer_id
         FROM
           rls_management_account_permissions_per_email
         WHERE (NOT (email IN (SELECT email
      FROM
        rls_full_access_per_email
      )))

      UNION ALL

      SELECT
          '' email
         , "group"
         , account_id
         , payer_id
         FROM
           rls_account_permissions_per_group
         WHERE ((NOT ("group" IN (SELECT "group" FROM rls_management_account_permissions_per_group)))
         AND (NOT ("group" IN (SELECT "group" FROM rls_full_access_per_group))))

      UNION ALL

      SELECT
           '' email
         , "group"
         , account_id
         , payer_id
         FROM
           rls_management_account_permissions_per_group
         WHERE (NOT ("group" IN (SELECT "group" FROM rls_full_access_per_group)))

      UNION ALL

      SELECT
           '' email
         , "group"
         , account_id
         , payer_id
      FROM
        rls_full_access_per_group

      )
      GROUP BY email, "group"
  rls_org_view:
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".rls_org_view AS
      SELECT
        Id account_id,
        ManagementAccountId payer_id,
        TRY(SPLIT(FILTER(HierarchyTags, (x) -> (x.key = 'cid_users'))[1].value, ',')) "emails",
        TRY(SPLIT(FILTER(HierarchyTags, (x) -> (x.key = 'cid_groups'))[1].value, ',')) "groups"
      FROM
        "${data_collection_database_name}"."organization_data"
    parameters:
      data_collection_database_name:
        type: athena
        query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'organization_data'
        error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
        default: optimization_data
        description: "Enter the name of the data collection database"
        global: True
  rls_full_access_users:
    data: |-
      CREATE VIEW "${athena_database_name}".rls_full_access_users AS
      SELECT *
      FROM
        (
       VALUES
           ROW ('fulladmin1@example.com')
         , ROW ('fulladmin2@example.com')
      )  ignored_table_name (email)
  rls_full_access_groups:
    data: |-
      CREATE VIEW "${athena_database_name}".rls_full_access_groups AS
      SELECT *
      FROM
        (
       VALUES
           ROW ('group1')
         , ROW ('group2')
      )  ignored_table_name ("group")
  rls_all_users_view:
    dependsOn:
      views:
      - rls_all_permissions
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".rls_all_users_view AS 
      WITH user_groups AS (
        SELECT
          quser.username,
          grp.groupname
        FROM "${data_collection_database_name}".quicksight_groupmembership_data grpmem
          INNER JOIN "${data_collection_database_name}".quicksight_user_data quser 
            ON quser.arn = grpmem.arn
            AND quser.account_id = grpmem.account_id
            AND quser.namespace = grpmem.namespace
          INNER JOIN "${data_collection_database_name}".quicksight_group_data grp 
            ON grp.arn = grpmem.grouparn
            AND grp.account_id = grpmem.account_id
            AND grp.namespace = grpmem.namespace
      ),
      user_permissions AS (
        -- Direct permissions (where email matches)
        SELECT
          qs.email,
          qs.username,
          rls."group" AS groupname,
          rls.account_ids,
          rls.payer_ids,
          'direct' AS permission_type
        FROM "${data_collection_database_name}".quicksight_user_data qs
          INNER JOIN rls_all_permissions rls
            ON qs.email = rls.email
        
        UNION ALL
        
        -- Indirect permissions (via group membership)
        SELECT
          qs.email,
          qs.username,
          rls."group" AS groupname,
          rls.account_ids,
          rls.payer_ids,
          'group' AS permission_type
        FROM "${data_collection_database_name}".quicksight_user_data qs
          INNER JOIN user_groups ug
            ON ug.username = qs.username
          INNER JOIN rls_all_permissions rls
            ON ug.groupname = rls."group"
      )
      SELECT DISTINCT
        up.email AS "email",
        up.username AS "UserName",
        up.groupname AS "GroupName",
        TRIM(account_id_split) AS account_id,
        TRIM(payer_id_split) AS payer_id,
        up.permission_type
      FROM user_permissions up
        CROSS JOIN UNNEST(
          CASE 
            WHEN up.account_ids IS NOT NULL AND up.account_ids != '' 
            THEN SPLIT(up.account_ids, ',') 
            ELSE ARRAY[CAST(NULL AS VARCHAR)]
          END
        ) AS t(account_id_split)
        CROSS JOIN UNNEST(
          CASE 
            WHEN up.payer_ids IS NOT NULL AND up.payer_ids != '' 
            THEN SPLIT(up.payer_ids, ',') 
            ELSE ARRAY[CAST(NULL AS VARCHAR)]
          END
        ) AS t2(payer_id_split)
    parameters:
      data_collection_database_name:
        type: athena
        query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'organization_data'
        error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
        default: optimization_data
        description: "Enter the name of the data collection database"
        global: True


