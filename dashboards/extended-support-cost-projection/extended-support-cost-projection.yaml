dashboards:
  EXTENDED SUPPORT COST PROJECTION:
    dependsOn:
      datasets:
      - eks_extended_support_view
      - rds_extended_support_view
      - opensearch_extended_support_view
      - elasticache_extended_support_view
      - extended_support_tagging_view
    name: Extended Support Cost Projection
    dashboardId: extended-support-cost-projection
    category: Advanced
    taxonomyDataset: extended_support_tagging_view
    nonTaxonomyDatasets:
    - rds_extended_support_view
    - eks_extended_support_view
    - opensearch_extended_support_view
    - elasticache_extended_support_view
    nonTaxonomyColumns:
    - tags_json
    file: ./extended-support-cost-projection-definition.yaml
    version: v4.0.5
datasets:
  elasticache_extended_support_view:
    data:
      DataSetId: f38e6e0e-2130-4d0e-96b9-133a9945a91f
      Name: elasticache_extended_support_view
      PhysicalTableMap:
        a201689c-b688-4037-a5ad-6282c4056d01:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: elasticache_extended_support_view
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: usage_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: engine
              Type: STRING
            - Name: region_code
              Type: STRING
            - Name: engineversion
              Type: STRING
            - Name: instance_type
              Type: STRING
            - Name: item_description
              Type: STRING
            - Name: cacheclusterid
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: original_usage_type
              Type: STRING
            - Name: on_demand_rate_per_unit
              Type: DECIMAL
              SubType: FLOAT
            - Name: usage_amount
              Type: DECIMAL
              SubType: FLOAT
            - Name: year_1_start
              Type: DATETIME
            - Name: is_year_1_2
              Type: STRING
            - Name: year_3_start
              Type: DATETIME
            - Name: is_year_3
              Type: STRING
            - Name: end_of_extended_support
              Type: DATETIME
            - Name: is_unsupported
              Type: STRING
            - Name: year_1_2_cost
              Type: DECIMAL
              SubType: FLOAT
            - Name: ext_sup_year_1_2_price
              Type: DECIMAL
              SubType: FLOAT
            - Name: year_3_cost
              Type: DECIMAL
              SubType: FLOAT
            - Name: ext_sup_year_3_price
              Type: DECIMAL
              SubType: FLOAT
      LogicalTableMap:
        c0037c45-1148-426d-9e1c-7f99c291c297:
          Alias: elasticache_extended_support_view
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - usage_date
              - payer_account_id
              - linked_account_id
              - account_name
              - engine
              - region_code
              - engineversion
              - instance_type
              - item_description
              - cacheclusterid
              - resource_id
              - original_usage_type
              - on_demand_rate_per_unit
              - usage_amount
              - year_1_start
              - is_year_1_2
              - year_3_start
              - is_year_3
              - end_of_extended_support
              - is_unsupported
              - year_1_2_cost
              - ext_sup_year_1_2_price
              - year_3_cost
              - ext_sup_year_3_price
          Source:
            PhysicalTableId: a201689c-b688-4037-a5ad-6282c4056d01
      ImportMode: SPICE
    dependsOn:
      views:
      - elasticache_extended_support_view
    schedules:
    - default
  eks_extended_support_view:
    data:
      DataSetId: 321e897c-7912-4cfd-bd4c-d15d0f948127
      Name: eks_extended_support_view
      PhysicalTableMap:
        2ae1dbc5-c18b-4751-8473-5864f5e91d44:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: eks_extended_support_view
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: usage_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: region_code
              Type: STRING
            - Name: original_usage_type
              Type: STRING
            - Name: k8s_version
              Type: STRING
            - Name: item_description
              Type: STRING
            - Name: cluster_name
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: usage_amount
              Type: DECIMAL
              SubType: FLOAT
            - Name: start_of_extended_support
              Type: DATETIME
            - Name: is_extended_support
              Type: STRING
            - Name: extended_support_cost
              Type: DECIMAL
              SubType: FLOAT
            - Name: end_of_extended_support
              Type: DATETIME
            - Name: is_out_of_extended_support
              Type: STRING
      LogicalTableMap:
        2cbef0f5-bd73-4791-840e-7221b6fb58e0:
          Alias: eks_extended_support_view
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - usage_date
              - payer_account_id
              - linked_account_id
              - account_name
              - region_code
              - original_usage_type
              - k8s_version
              - item_description
              - cluster_name
              - resource_id
              - usage_amount
              - start_of_extended_support
              - is_extended_support
              - extended_support_cost
              - end_of_extended_support
              - is_out_of_extended_support
          Source:
            PhysicalTableId: 2ae1dbc5-c18b-4751-8473-5864f5e91d44
      ImportMode: SPICE
    dependsOn:
      views:
      - eks_extended_support_view
    schedules:
    - default
  rds_extended_support_view:
    data:
      DataSetId: 31961243-0137-4201-a8d1-c2a00755765e
      Name: rds_extended_support_view
      PhysicalTableMap:
        76a6ad9d-caf0-447f-8609-1c4d8fb89673:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: rds_extended_support_view
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: usage_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: region_code
              Type: STRING
            - Name: rds_type
              Type: STRING
            - Name: deployment_option
              Type: STRING
            - Name: original_deployment_option
              Type: STRING
            - Name: original_usage_type
              Type: STRING
            - Name: engine
              Type: STRING
            - Name: engineversion
              Type: STRING
            - Name: instance_type_family
              Type: STRING
            - Name: instance_type
              Type: STRING
            - Name: item_description
              Type: STRING
            - Name: dbresourceidentifier
              Type: STRING
            - Name: resource_id
              Type: STRING
            - Name: vcpus
              Type: INTEGER
            - Name: usage_unit
              Type: STRING
            - Name: usage_amount
              Type: DECIMAL
              SubType: FLOAT
            - Name: vcpu_acu_hours
              Type: DECIMAL
              SubType: FLOAT
            - Name: year_1_start
              Type: DATETIME
            - Name: is_year_1_2
              Type: STRING
            - Name: year_3_start
              Type: DATETIME
            - Name: is_year_3
              Type: STRING
            - Name: end_of_extended_support
              Type: DATETIME
            - Name: is_unsupported
              Type: STRING
            - Name: year_1_2_pricing
              Type: DECIMAL
              SubType: FLOAT
            - Name: year_1_2_cost
              Type: DECIMAL
              SubType: FLOAT
            - Name: year_3_pricing
              Type: DECIMAL
              SubType: FLOAT
            - Name: year_3_cost
              Type: DECIMAL
              SubType: FLOAT
      LogicalTableMap:
        ba51b0b7-2118-49f3-85f2-399ae50255b4:
          Alias: rds_extended_support_view
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - usage_date
              - payer_account_id
              - linked_account_id
              - account_name
              - region_code
              - rds_type
              - deployment_option
              - original_deployment_option
              - original_usage_type
              - engine
              - engineversion
              - instance_type_family
              - instance_type
              - item_description
              - dbresourceidentifier
              - resource_id
              - vcpus
              - usage_unit
              - usage_amount
              - vcpu_acu_hours
              - year_1_start
              - is_year_1_2
              - year_3_start
              - is_year_3
              - end_of_extended_support
              - is_unsupported
              - year_1_2_pricing
              - year_1_2_cost
              - year_3_pricing
              - year_3_cost
          Source:
            PhysicalTableId: 76a6ad9d-caf0-447f-8609-1c4d8fb89673
      ImportMode: SPICE
    dependsOn:
      views:
      - rds_extended_support_view
    schedules:
    - default
  opensearch_extended_support_view:
    data:
      DataSetId: ecb9e3a1-3e67-482a-989c-1c403c8bd912
      Name: opensearch_extended_support_view
      PhysicalTableMap:
        b51ef4eb-f8bd-41d1-8ed4-bce50612fb1b:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: opensearch_extended_support_view
            InputColumns:
            - Name: billing_period
              Type: DATETIME
            - Name: usage_date
              Type: DATETIME
            - Name: payer_account_id
              Type: STRING
            - Name: linked_account_id
              Type: STRING
            - Name: account_name
              Type: STRING
            - Name: region_code
              Type: STRING
            - Name: domainname
              Type: STRING
            - Name: domainidentifier
              Type: STRING
            - Name: resourceid
              Type: STRING
            - Name: engineversion
              Type: STRING
            - Name: instance_type
              Type: STRING
            - Name: instance_size
              Type: STRING
            - Name: norm_factor
              Type: DECIMAL
              SubType: FLOAT
            - Name: item_description
              Type: STRING
            - Name: usage_unit
              Type: STRING
            - Name: original_usage_type
              Type: STRING
            - Name: usage_amount
              Type: DECIMAL
              SubType: FLOAT
            - Name: nihs
              Type: DECIMAL
              SubType: FLOAT
            - Name: start_of_extended_support
              Type: DATETIME
            - Name: end_of_extended_support
              Type: DATETIME
            - Name: nih_pricing
              Type: DECIMAL
              SubType: FLOAT
            - Name: projected_extended_support_cost
              Type: DECIMAL
              SubType: FLOAT
      LogicalTableMap:
        6f0bc2eb-2e93-42f6-a747-b4facc207d58:
          Alias: opensearch_extended_support_view
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - billing_period
              - usage_date
              - payer_account_id
              - linked_account_id
              - account_name
              - region_code
              - domainname
              - domainidentifier
              - resourceid
              - engineversion
              - instance_type
              - instance_size
              - norm_factor
              - item_description
              - usage_unit
              - original_usage_type
              - usage_amount
              - nihs
              - start_of_extended_support
              - end_of_extended_support
              - nih_pricing
              - projected_extended_support_cost
          Source:
            PhysicalTableId: b51ef4eb-f8bd-41d1-8ed4-bce50612fb1b
      ImportMode: SPICE
    dependsOn:
      views:
      - opensearch_extended_support_view
    schedules:
    - default
  extended_support_tagging_view:
    data:
      DataSetId: 0655eb28-3f36-4a5d-8e8a-c2d70cd09fc7
      Name: extended_support_tagging_view
      PhysicalTableMap:
        5a574f8c-5e74-4da8-97cc-4f6802a7d360:
          RelationalTable:
            DataSourceArn: ${athena_datasource_arn}
            Catalog: AwsDataCatalog
            Schema: ${athena_database_name}
            Name: extended_support_tagging_view
            InputColumns:
            - Name: line_item_product_code
              Type: STRING
            - Name: tags_json
              Type: STRING
      LogicalTableMap:
        30248d27-4a3a-4350-bf1d-dd382f040c95:
          Alias: extended_support_tagging_view
          DataTransforms:
          - ProjectOperation:
              ProjectedColumns:
              - line_item_product_code
              - tags_json
          Source:
            PhysicalTableId: 5a574f8c-5e74-4da8-97cc-4f6802a7d360
      ImportMode: SPICE
    dependsOn:
      views:
      - extended_support_tagging_view
    schedules:
    - default
views:
  elasticache_extended_support_view:
    dependsOn:
      tags: json
      cur2:
        - product_product_family
        - product_servicecode
        - product['region']
        - pricing_public_on_demand_rate
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".elasticache_extended_support_view AS
      WITH
        engine_release_calendar (engineversion, year_1_start, year_3_start, end_of_extended_support) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('redis OSS v4', CAST('2026-02-01' AS timestamp), CAST('2028-02-01' AS timestamp), CAST('2029-01-31' AS timestamp))
            , ROW ('redis OSS v5', CAST('2026-02-01' AS timestamp), CAST('2028-02-01' AS timestamp), CAST('2029-01-31' AS timestamp))
            , ROW ('redis OSS v6', CAST('2027-02-01' AS timestamp), CAST('2029-02-01' AS timestamp), CAST('2030-01-31' AS timestamp))
         )
      )
      , preprocessed_elasticache_clusters (payer_id, accountid, region, cacheclusterid, engine, engineversion, collection_date, max_collection_date) AS (
         SELECT DISTINCT
            payer_id
          , accountid
          , region
          , cacheclusterid
          , engine
          , engineversion
          , CAST("concat"("year", '-', "month", '-', "day") AS date)
          , max(CAST("concat"("year", '-', "month", '-', "day") AS date)) OVER (ORDER BY cacheclusterid ASC)
          FROM ${data_collection_database_name}.inventory_elasticache_clusters_data
          WHERE (CAST("concat"("year", '-', "month", '-', "day") AS date) >= ("date_trunc"('day', current_date) - INTERVAL  '30' DAY))
      )
      , sanitised_elasticache_clusters (payer_id, accountid, region, cacheclusterid, engine, engineversion) AS (
         SELECT DISTINCT
           payer_id
         , accountid
         , region
         , cacheclusterid
         , engine
         , engineversion
         FROM
           preprocessed_elasticache_clusters
         WHERE (collection_date = max_collection_date)
      )
      , elasticache_resources (billing_period, usage_date, payer_account_id, linked_account_id, account_name, region_code, engine, engineversion, instance_type, item_description, cacheclusterid, resource_id, original_usage_type, on_demand_rate_per_unit, tags_json, usage_amount, ext_sup_year_1_2_price, ext_sup_year_3_price) AS (
         SELECT
           c.bill_billing_period_start_date billing_period
         , date_trunc('day', c.line_item_usage_start_date) usage_date
         , c.bill_payer_account_id payer_account_id
         , c.line_item_usage_account_id linked_account_id
         , accmap.account_name
         , c.product['region'] region_code
         , engine
         , engineversion
         , c.product_instance_type instance_type
         , c.line_item_line_item_description item_description
         , ecsu.cacheclusterid cacheclusterid
         , c.line_item_resource_id resource_id
         , c.line_item_usage_type original_usage_type
         , round(CAST(c.pricing_public_on_demand_rate AS double), 4) on_demand_rate_per_unit
         , ${cur_tags_json} tags_json
         , sum(line_item_usage_amount) usage_amount
         , sum(((line_item_usage_amount * round(CAST(c.pricing_public_on_demand_rate AS double), 4)) * 8E-1)) ext_sup_year_1_2_price
         , sum(((line_item_usage_amount * round(CAST(c.pricing_public_on_demand_rate AS double), 4)) * 1.6E0)) ext_sup_year_3_price
         FROM
           (("${cur2_database}"."${cur2_table_name}" c
         INNER JOIN sanitised_elasticache_clusters ecsu ON ((c.bill_payer_account_id = ecsu.payer_id) AND (c.line_item_usage_account_id = ecsu.accountid) AND (c.product['region'] = ecsu.region) AND (split_part(c.line_item_resource_id, ':', 7) = ecsu.cacheclusterid)))
         INNER JOIN account_map accmap ON (c.line_item_usage_account_id = accmap.account_id))
         WHERE (((c.bill_billing_period_start_date >= (date_trunc('month', current_timestamp) - INTERVAL  '4' MONTH)) AND (CAST(concat(c.billing_period, '-01') AS date) >= (date_trunc('month', current_date) - INTERVAL  '4' MONTH))) AND (c.product_servicecode = 'AmazonElastiCache') AND (c.product_product_family = 'Cache Instance') AND (c.product['cache_engine'] = 'Redis') AND (c.line_item_line_item_type IN ('DiscountedUsage', 'Usage')))
         GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15
      )
      SELECT
        ecr.billing_period
      , ecr.usage_date
      , ecr.payer_account_id
      , ecr.linked_account_id
      , ecr.account_name
      , ecr.engine
      , ecr.region_code
      , erc.engineversion
      , ecr.instance_type
      , ecr.item_description
      , ecr.cacheclusterid
      , ecr.resource_id
      , ecr.original_usage_type
      , ecr.on_demand_rate_per_unit
      , ecr.usage_amount
      , erc.year_1_start
      , (CASE WHEN ((current_timestamp >= erc.year_1_start) AND (current_timestamp < erc.year_3_start)) THEN 'Y' ELSE 'N' END) is_year_1_2
      , erc.year_3_start
      , (CASE WHEN ((current_timestamp >= erc.year_3_start) AND (current_timestamp < erc.end_of_extended_support)) THEN 'Y' ELSE 'N' END) is_year_3
      , erc.end_of_extended_support
      , (CASE WHEN (current_timestamp >= erc.end_of_extended_support) THEN 'Y' ELSE 'N' END) is_unsupported
      , (CASE WHEN ((current_timestamp >= erc.year_1_start) AND (current_timestamp < erc.year_3_start)) THEN ext_sup_year_1_2_price ELSE 0 END) year_1_2_cost
      , ext_sup_year_1_2_price
      , (CASE WHEN ((current_timestamp >= erc.year_3_start) AND (current_timestamp < erc.end_of_extended_support)) THEN ext_sup_year_3_price ELSE 0 END) year_3_cost
      , ext_sup_year_3_price
      , ecr.tags_json
      FROM
        (elasticache_resources ecr
      INNER JOIN engine_release_calendar erc ON (concat(ecr.engine, ' OSS v', substr(ecr.engineversion, 1, 1)) = erc.engineversion))
    parameters:
        data_collection_database_name:
          type: athena
          query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'inventory_elasticache_clusters_data'
          error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
          default: optimization_data
          description: "Enter the name of the data collection database"
          global: True
  eks_extended_support_view:
    dependsOn:
      tags: json
      cur2:
        - pricing_unit
        - product['region']
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".eks_extended_support_view AS
      WITH
        eks_k8s_release_calendar (k8s_version, start_of_extended_support, end_of_extended_support) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('1.21', CAST('2023-02-17' AS timestamp), CAST('2024-07-15' AS timestamp))
            , ROW ('1.22', CAST('2023-06-05' AS timestamp), CAST('2024-09-01' AS timestamp))
            , ROW ('1.23', CAST('2023-10-12' AS timestamp), CAST('2024-10-11' AS timestamp))
            , ROW ('1.24', CAST('2024-02-01' AS timestamp), CAST('2025-01-31' AS timestamp))
            , ROW ('1.25', CAST('2024-05-02' AS timestamp), CAST('2025-05-01' AS timestamp))
            , ROW ('1.26', CAST('2024-06-12' AS timestamp), CAST('2025-06-11' AS timestamp))
            , ROW ('1.27', CAST('2024-07-25' AS timestamp), CAST('2025-07-24' AS timestamp))
            , ROW ('1.28', CAST('2024-11-27' AS timestamp), CAST('2025-11-26' AS timestamp))
            , ROW ('1.29', CAST('2025-03-24' AS timestamp), CAST('2026-03-23' AS timestamp))
            , ROW ('1.30', CAST('2025-07-24' AS timestamp), CAST('2026-07-23' AS timestamp))
            , ROW ('1.31', CAST('2025-11-27' AS timestamp), CAST('2026-11-26' AS timestamp))
            , ROW ('1.32', CAST('2026-03-24' AS timestamp), CAST('2027-03-23' AS timestamp))
            , ROW ('1.33', CAST('2026-07-30' AS timestamp), CAST('2027-07-29' AS timestamp))
            , ROW ('1.34', CAST('2026-12-03' AS timestamp), CAST('2027-12-02' AS timestamp))
         )
      )
      , preprocessed_eks_clusters_inventory (payer_id, accountid, region, cluster_arn, cluster_name, k8s_version, collection_date, max_collection_date) AS (
          SELECT DISTINCT
               payer_id
             , accountid
             , region
             , arn
             , name
             , version
             , CAST("concat"("year", '-', "month", '-', "day") AS date)
             , max(CAST("concat"("year", '-', "month", '-', "day") AS date)) over (order by name)
             FROM ${data_collection_database_name}.inventory_eks_data
             WHERE (CAST("concat"("year", '-', "month", '-', "day") AS date) >= ("date_trunc"('day', current_date) - INTERVAL  '15' DAY))
      )
      , eks_clusters_inventory (payer_id, accountid, region, cluster_arn, cluster_name, k8s_version) AS (
          SELECT DISTINCT
               payer_id
             , accountid
             , region
             , cluster_arn
             , cluster_name
             , k8s_version
             FROM preprocessed_eks_clusters_inventory
             WHERE collection_date = max_collection_date
      )
      , eks_clusters_usage (billing_period, usage_date, payer_account_id, linked_account_id, account_name, region_code, cluster_name, k8s_version, item_description, usage_unit, resource_id, original_usage_type, tags_json, usage_amount) AS (
         SELECT
           c.bill_billing_period_start_date
         , date_trunc('day', c.line_item_usage_start_date)
         , c.bill_payer_account_id payer_account_id
         , c.line_item_usage_account_id linked_account_id
         , accmap.account_name
         , c.product['region'] region_code
         , eksinv.cluster_name
         , eksinv.k8s_version
         , c.line_item_line_item_description item_description
         , c.pricing_unit
         , c.line_item_resource_id
         , c.line_item_usage_type
         , ${cur_tags_json} tags_json
         , sum(c.line_item_usage_amount)
         FROM
           ("${cur2_database}"."${cur2_table_name}" c
         INNER JOIN eks_clusters_inventory eksinv ON ((c.bill_payer_account_id = eksinv.payer_id) AND (c.line_item_usage_account_id = eksinv.accountid) AND (c.product['region'] = eksinv.region) AND (c.line_item_resource_id = eksinv.cluster_arn)))
         INNER JOIN account_map accmap on c.line_item_usage_account_id = accmap.account_id
         WHERE (((c.bill_billing_period_start_date >= ("date_trunc"('month', current_timestamp) - INTERVAL  '4' MONTH)) AND (CAST(concat(c.billing_period, '-01') AS date) >= (date_trunc('month', current_date) - INTERVAL  '4' MONTH))) AND (c.product_servicecode = 'AmazonEKS') AND (c.line_item_line_item_type IN ('Usage')) AND ((c.product_product_family = 'Compute') AND (c.line_item_usage_type LIKE '%AmazonEKS-Hours:perCluster')))
         GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13
      )
      SELECT
        ekscus.billing_period
      , ekscus.usage_date
      , ekscus.payer_account_id
      , ekscus.linked_account_id
      , ekscus.account_name
      , ekscus.region_code
      , ekscus.original_usage_type
      , ekscus.k8s_version
      , ekscus.item_description
      , ekscus.cluster_name
      , ekscus.resource_id
      , ekscus.usage_amount
      , rc.start_of_extended_support
      , (CASE WHEN ((current_timestamp >= rc.start_of_extended_support) AND (current_timestamp < rc.end_of_extended_support)) THEN 'Y' ELSE 'N' END) is_extended_support
      , (ekscus.usage_amount * 6E-1) extended_support_cost
      , rc.end_of_extended_support
      , (CASE WHEN (current_timestamp >= rc.end_of_extended_support) THEN 'Y' ELSE 'N' END) is_out_of_extended_support
      , ekscus.tags_json
      FROM
        (eks_clusters_usage ekscus
      INNER JOIN eks_k8s_release_calendar rc ON (ekscus.k8s_version = rc.k8s_version))
    parameters:
        data_collection_database_name:
          type: athena
          query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'inventory_eks_data'
          error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
          default: optimization_data
          description: "Enter the name of the data collection database"
          global: True
  rds_extended_support_view:
    dependsOn:
      tags: json
      cur2:
        - pricing_unit
        - product['database_engine']
        - product['deployment_option']
        - product['instance_type']
        - product['instance_type_family']
        - product_product_family
        - product['region']
        - product['vcpu']
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".rds_extended_support_view AS
      WITH
        engine_release_calendar (engineversion, year_1_start, year_3_start, end_of_extended_support) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('mysql5.7', CAST('2024-03-01' AS timestamp), CAST('2026-03-01' AS timestamp), CAST('2027-02-28' AS timestamp))
            , ROW ('mysql8.0', CAST('2026-08-01' AS timestamp), CAST('2028-08-01' AS timestamp), CAST('2029-07-31' AS timestamp))
            , ROW ('mysql8.4', CAST('2029-08-01' AS timestamp), CAST('2031-08-01' AS timestamp), CAST('2032-07-31' AS timestamp))
            , ROW ('postgres11.22', CAST('2024-04-01' AS timestamp), CAST('2026-04-01' AS timestamp), CAST('2027-03-31' AS timestamp))
            , ROW ('postgres12', CAST('2025-03-01' AS timestamp), CAST('2027-03-01' AS timestamp), CAST('2028-02-29' AS timestamp))
            , ROW ('postgres13', CAST('2026-03-01' AS timestamp), CAST('2028-03-01' AS timestamp), CAST('2029-02-28' AS timestamp))
            , ROW ('postgres14', CAST('2027-03-01' AS timestamp), CAST('2029-03-01' AS timestamp), CAST('2030-02-28' AS timestamp))
            , ROW ('postgres15', CAST('2028-03-01' AS timestamp), CAST('2030-03-01' AS timestamp), CAST('2031-02-28' AS timestamp))
            , ROW ('postgres16', CAST('2029-03-01' AS timestamp), CAST('2031-03-01' AS timestamp), CAST('2032-02-29' AS timestamp))
            , ROW ('postgres17', CAST('2030-03-01' AS timestamp), CAST('2032-03-01' AS timestamp), CAST('2033-02-28' AS timestamp))
            , ROW ('aurora-mysql2.11', CAST('2024-12-01' AS timestamp), null, CAST('2027-02-28' AS timestamp))
            , ROW ('aurora-mysql2.12', CAST('2024-12-01' AS timestamp), null, CAST('2027-02-28' AS timestamp))
            , ROW ('aurora-mysql3', CAST('2028-05-01' AS timestamp), null, CAST('2029-07-31' AS timestamp))
            , ROW ('aurora-postgresql11.9', CAST('2024-04-01' AS timestamp), CAST('2026-04-01' AS timestamp), CAST('2027-03-31' AS timestamp))
            , ROW ('aurora-postgresql11.21', CAST('2024-04-01' AS timestamp), CAST('2026-04-01' AS timestamp), CAST('2027-03-31' AS timestamp))
            , ROW ('aurora-postgresql12', CAST('2025-03-01' AS timestamp), CAST('2027-03-01' AS timestamp), CAST('2028-02-29' AS timestamp))
            , ROW ('aurora-postgresql13', CAST('2026-03-01' AS timestamp), CAST('2028-03-01' AS timestamp), CAST('2029-02-28' AS timestamp))
            , ROW ('aurora-postgresql14', CAST('2027-03-01' AS timestamp), CAST('2029-03-01' AS timestamp), CAST('2030-02-28' AS timestamp))
            , ROW ('aurora-postgresql15', CAST('2028-03-01' AS timestamp), CAST('2030-03-01' AS timestamp), CAST('2031-02-28' AS timestamp))
            , ROW ('aurora-postgresql16', CAST('2029-03-01' AS timestamp), CAST('2031-03-01' AS timestamp), CAST('2032-02-28' AS timestamp))
         )
      )
      , regions_pricing (rds_type, region_code, year_1_2_pricing, year_3_pricing) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('AmazonRDS', 'eu-south-1', 1.176E-1, 2.352E-1)
            , ROW ('AmazonRDS', 'us-west-2', 1E-1, 2E-1)
            , ROW ('AmazonRDS', 'ap-south-2', 1.14E-1, 2.28E-1)
            , ROW ('AmazonRDS', 'me-central-1', 1.23E-1, 2.464E-1)
            , ROW ('AmazonRDS', 'eu-west-3', 1.176E-1, 2.352E-1)
            , ROW ('AmazonRDS', 'us-east-2', 1E-1, 2E-1)
            , ROW ('AmazonRDS', 'sa-east-1', 2.096E-1, 4.192E-1)
            , ROW ('AmazonRDS', 'me-south-1', 1.232E-1, 2.464E-1)
            , ROW ('AmazonRDS', 'ap-northeast-2', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'ap-southeast-2', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'us-west-1', 1.12E-1, 2.24E-1)
            , ROW ('AmazonRDS', 'ca-central-1', 1.08E-1, 2.16E-1)
            , ROW ('AmazonRDS', 'eu-north-1', 1.028E-1, 2.056E-1)
            , ROW ('AmazonRDS', 'ap-southeast-3', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'ap-east-1', 1.32E-1, 2.64E-1)
            , ROW ('AmazonRDS', 'eu-central-2', 1.344E-1, 2.688E-1)
            , ROW ('AmazonRDS', 'eu-west-2', 1.176E-1, 2.352E-1)
            , ROW ('AmazonRDS', 'ap-south-1', 1.14E-1, 2.28E-1)
            , ROW ('AmazonRDS', 'eu-west-1', 1.12E-1, 2.24E-1)
            , ROW ('AmazonRDS', 'us-east-1', 1E-1, 2E-1)
            , ROW ('AmazonRDS', 'ap-southeast-1', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'ap-northeast-3', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'eu-south-2', 1.12E-1, 2.24E-1)
            , ROW ('AmazonRDS', 'eu-central-1', 1.22E-1, 2.44E-1)
            , ROW ('AmazonRDS', 'ap-northeast-1', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'af-south-1', 1.332E-1, 2.664E-1)
            , ROW ('AmazonRDS', 'us-west-2-lax-1', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'ap-southeast-4', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'il-central-1', 1.176E-1, 2.352E-1)
            , ROW ('AmazonRDS', 'us-gov-east-1', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'us-gov-west-1', 1.2E-1, 2.4E-1)
            , ROW ('AmazonRDS', 'cn-north-1', 9.74E-1, 1.948E0)
            , ROW ('AmazonRDS', 'cn-northwest-1', 6.68E-1, 1.336E0)
            , ROW ('Aurora', 'eu-south-1', 9.996E-2, 1.9992E-1)
            , ROW ('Aurora', 'us-west-2', 8.5E-2, 1.7E-1)
            , ROW ('Aurora', 'ap-south-2', 9.69E-2, 1.938E-1)
            , ROW ('Aurora', 'me-central-1', 1.0472E-1, 2.0944E-1)
            , ROW ('Aurora', 'eu-west-3', 9.996E-2, 1.9992E-1)
            , ROW ('Aurora', 'us-east-2', 8.5E-2, 1.7E-1)
            , ROW ('Aurora', 'sa-east-1', 1.7816E-1, 3.5632E-1)
            , ROW ('Aurora', 'me-south-1', 1.0472E-1, 2.0944E-1)
            , ROW ('Aurora', 'ap-northeast-2', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'ap-southeast-2', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'us-west-1', 9.52E-2, 1.904E-1)
            , ROW ('Aurora', 'ca-central-1', 9.18E-2, 1.836E-1)
            , ROW ('Aurora', 'eu-north-1', 8.738E-2, 1.7476E-1)
            , ROW ('Aurora', 'ap-southeast-3', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'ap-east-1', 1.122E-1, 2.244E-1)
            , ROW ('Aurora', 'eu-central-2', 1.1424E-1, 2.2848E-1)
            , ROW ('Aurora', 'eu-west-2', 9.996E-2, 1.9992E-1)
            , ROW ('Aurora', 'ap-south-1', 9.69E-2, 1.938E-1)
            , ROW ('Aurora', 'eu-west-1', 9.52E-2, 1.904E-1)
            , ROW ('Aurora', 'us-east-1', 8.5E-2, 1.7E-1)
            , ROW ('Aurora', 'ap-southeast-1', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'ap-northeast-3', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'eu-south-2', 9.52E-2, 1.904E-1)
            , ROW ('Aurora', 'eu-central-1', 1.037E-1, 2.074E-1)
            , ROW ('Aurora', 'ap-northeast-1', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'af-south-1', 1.1322E-1, 2.2644E-1)
            , ROW ('Aurora', 'us-west-2-lax-1', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'ap-southeast-4', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'il-central-1', 9.996E-2, 1.9992E-1)
            , ROW ('Aurora', 'us-gov-east-1', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'us-gov-west-1', 1.02E-1, 2.04E-1)
            , ROW ('Aurora', 'cn-north-1', 8.28E-1, 1.656E0)
            , ROW ('Aurora', 'cn-northwest-1', 5.68E-1, 1.136E0)
         )
      )
      , preprocessed_rds_instances (payer_id, accountid, region, dbinstanceidentifier, engine, engineversion, collection_date, max_collection_date) AS (
          SELECT DISTINCT
               payer_id
             , accountid
             , region
             , dbinstanceidentifier
             , engine
             , CASE
                  WHEN engine = 'aurora-mysql' THEN split(engineversion, 'mysql_aurora.')[2]
                  ELSE engineversion
             END
             , CAST("concat"("year", '-', "month", '-', "day") AS date)
             , max(CAST("concat"("year", '-', "month", '-', "day") AS date)) over (order by dbinstanceidentifier)
             FROM ${data_collection_database_name}.inventory_rds_db_instances_data
            WHERE (CAST("concat"("year", '-', "month", '-', "day") AS date) >= ("date_trunc"('day', current_date) - INTERVAL  '15' DAY))
          )
      , sanitised_rds_instances (payer_id, accountid, region, dbinstanceidentifier, engine, engineversion) AS (
         SELECT DISTINCT
           payer_id
         , accountid
         , region
         , dbinstanceidentifier
         , engine
         , CASE 
              WHEN engine = 'aurora-mysql' and starts_with(engineversion, '2') THEN substr(engineversion, 1, strpos(engineversion, '.', 2) - 1)
              WHEN engine = 'aurora-mysql' and starts_with(engineversion, '3') THEN substr(engineversion, 1, strpos(engineversion, '.', 1) - 1)
              WHEN engine = 'aurora-postgresql' and not starts_with(engineversion, '11') THEN substr(engineversion, 1, strpos(engineversion, '.', 1) - 1)
              WHEN engine = 'mysql' THEN substr(engineversion, 1, strpos(engineversion, '.', 2) - 1)
              WHEN engine = 'postgres' and not starts_with(engineversion, '11') THEN substr(engineversion, 1, strpos(engineversion, '.', 1) - 1)
              ELSE engineversion
          END
         FROM preprocessed_rds_instances
         WHERE collection_date = max_collection_date
      )
      , preprocessed_rds_clusters (payer_id, accountid, region, dbclusteridentifier, engine, engineversion, collection_date, max_collection_date) AS (
         SELECT DISTINCT
           payer_id
         , accountid
         , region
         , dbclusteridentifier
         , engine
         , (CASE WHEN (engine = 'aurora-mysql') THEN split(engineversion, 'mysql_aurora.')[2] ELSE engineversion END)
         , CAST("concat"("year", '-', "month", '-', "day") AS date)
         , max(CAST("concat"("year", '-', "month", '-', "day") AS date)) OVER (ORDER BY dbclusteridentifier ASC)
         FROM
           ${data_collection_database_name}.inventory_rds_db_clusters_data
         WHERE (CAST("concat"("year", '-', "month", '-', "day") AS date) >= ("date_trunc"('day', current_date) - INTERVAL  '15' DAY))
           AND enginemode = 'serverless'
      )
      , sanitised_rds_clusters (payer_id, accountid, region, dbclusteridentifier, engine, engineversion) AS (
         SELECT DISTINCT
           payer_id
         , accountid
         , region
         , dbclusteridentifier
         , engine
         , (CASE WHEN ((engine = 'aurora-mysql') AND starts_with(engineversion, '2')) THEN substr(engineversion, 1, (strpos(engineversion, '.', 2) - 1)) WHEN ((engine = 'aurora-mysql') AND starts_with(engineversion, '3')) THEN substr(engineversion, 1, (strpos(engineversion, '.', 1) - 1)) WHEN ((engine = 'aurora-postgresql') AND (NOT starts_with(engineversion, '11'))) THEN substr(engineversion, 1, (strpos(engineversion, '.', 1) - 1)) WHEN (engine = 'mysql') THEN substr(engineversion, 1, (strpos(engineversion, '.', 2) - 1)) WHEN ((engine = 'postgres') AND (NOT starts_with(engineversion, '11'))) THEN substr(engineversion, 1, (strpos(engineversion, '.', 1) - 1)) ELSE engineversion END)
         FROM
           preprocessed_rds_clusters
         WHERE (collection_date = max_collection_date)
      )
      , all_sanitised_rds_resources (payer_id, accountid, region, dbresourceidentifier, engine, engineversion) as (
         SELECT payer_id
             , accountid
             , region
             , dbinstanceidentifier
             , engine
             , engineversion
           FROM sanitised_rds_instances
          UNION
         SELECT payer_id
             , accountid
             , region
             , dbclusteridentifier
             , engine
             , engineversion
           FROM sanitised_rds_clusters
      )
      , rds_resources (billing_period, usage_date, payer_account_id, linked_account_id, account_name, region_code, rds_type, deployment_option, engine, engineversion, instance_type_family, instance_type, item_description, vcpus, usage_unit, dbresourceidentifier, resource_id, original_deployment_option, original_usage_type, tags_json, usage_amount, vcpu_acu_hours) AS (
         SELECT
           c.bill_billing_period_start_date billing_period
         , date_trunc('day', c.line_item_usage_start_date) usage_date
         , c.bill_payer_account_id payer_account_id
         , c.line_item_usage_account_id linked_account_id
         , accmap.account_name
         , c.product['region'] region_code
         , (CASE WHEN (c.product['database_engine'] LIKE 'Aurora%') THEN 'Aurora' ELSE 'AmazonRDS' END) rds_type
         , (CASE WHEN (c.line_item_usage_type LIKE '%InstanceUsage%') THEN 'SINGLE-AZ' WHEN (c.line_item_usage_type LIKE '%Multi-AZUsage%') THEN 'MULTI-AZ' WHEN (c.line_item_usage_type LIKE '%Multi-AZClusterUsage%') THEN 'MULTI-AZ-CLUSTER' WHEN ((c.product_product_family = 'Serverless') AND (c.line_item_usage_type like '%Aurora:Serverless%Usage')) THEN 'SERVERLESS' WHEN ((c.product_product_family = 'ServerlessV2') AND (c.line_item_usage_type like '%Aurora:ServerlessV2%Usage')) THEN 'SERVERLESSV2' ELSE 'UNDEFINED (Check the usage type)' END) deployment_option
         , (CASE WHEN (rdsu.engine IS NOT NULL) THEN rdsu.engine ELSE c.product['database_engine'] END) engine
         , (CASE WHEN ((rdsu.engine IS NOT NULL) AND (rdsu.engineversion IS NOT NULL)) THEN CONCAT(rdsu.engine, rdsu.engineversion) ELSE 'engine-1.-1.-1' END) engineversion
         , c.product['instance_type_family'] instance_type_family
         , c.product['instance_type'] instance_type
         , c.line_item_line_item_description item_description
         , (CASE WHEN ((c.product_product_family like 'Serverless%') AND (c.line_item_usage_type like '%Aurora:Serverless%Usage')) THEN 0 ELSE CAST(c.product['vcpu'] AS int) END) vcpus
         , (CASE WHEN ((c.product_product_family = 'ServerlessV2') AND (c.line_item_usage_type like '%Aurora:ServerlessV2%Usage')) THEN 'acu-hour' ELSE 'vcpu-hour' END) usage_unit
         , split_part(c.line_item_resource_id, ':', 7) dbresourceidentifier
         , c.line_item_resource_id resource_id
         , c.product['deployment_option'] original_deployment_option
         , c.line_item_usage_type original_usage_type
         , ${cur_tags_json} tags_json
         , sum(c.line_item_usage_amount) usage_amount
         , sum((CASE WHEN (c.pricing_unit = 'ACU-Hr') THEN c.line_item_usage_amount WHEN (c.line_item_usage_type LIKE '%Multi-AZUsage%') THEN (CAST(c.product['vcpu'] AS int) * c.line_item_usage_amount * 2) ELSE (CAST(c.product['vcpu'] AS int) * c.line_item_usage_amount) END)) vcpu_acu_hours
         FROM
           (("${cur2_database}"."${cur2_table_name}" c
         INNER JOIN all_sanitised_rds_resources rdsu ON ((c.bill_payer_account_id = rdsu.payer_id) AND (c.line_item_usage_account_id = rdsu.accountid) AND (c.product['region'] = rdsu.region) AND (split_part(c.line_item_resource_id, ':', 7) = rdsu.dbresourceidentifier)))
         INNER JOIN account_map accmap ON (c.line_item_usage_account_id = accmap.account_id))
         WHERE (((c.bill_billing_period_start_date >= (date_trunc('month', current_timestamp) - INTERVAL  '4' MONTH)) AND (CAST(concat(c.billing_period, '-01') AS date) >= (date_trunc('month', current_date) - INTERVAL  '4' MONTH))) AND (c.product_servicecode = 'AmazonRDS') AND (c.line_item_line_item_type IN ('DiscountedUsage', 'Usage')) AND ((c.product_product_family = 'Database Instance') OR ((c.product_product_family like 'Serverless%') AND (c.line_item_usage_type like '%Aurora:Serverless%Usage'))))
         GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20
      )
      SELECT
        rdsr.billing_period
      , rdsr.usage_date
      , rdsr.payer_account_id
      , rdsr.linked_account_id
      , rdsr.account_name
      , rdsr.region_code
      , rdsr.rds_type
      , rdsr.deployment_option
      , rdsr.original_deployment_option
      , rdsr.original_usage_type
      , rdsr.engine
      , rdsr.engineversion
      , rdsr.instance_type_family
      , rdsr.instance_type
      , rdsr.item_description
      , rdsr.dbresourceidentifier
      , rdsr.resource_id
      , rdsr.vcpus
      , rdsr.usage_unit
      , rdsr.usage_amount
      , rdsr.vcpu_acu_hours
      , erc.year_1_start
      , (CASE WHEN ((current_timestamp >= erc.year_1_start) AND (current_timestamp < erc.year_3_start)) THEN 'Y' ELSE 'N' END) is_year_1_2
      , erc.year_3_start
      , (CASE WHEN ((current_timestamp >= erc.year_3_start) AND (current_timestamp < erc.end_of_extended_support)) THEN 'Y' ELSE 'N' END) is_year_3
      , erc.end_of_extended_support
      , (CASE WHEN (current_timestamp >= erc.end_of_extended_support) THEN 'Y' ELSE 'N' END) is_unsupported
      , rp.year_1_2_pricing
      , (CASE WHEN ((current_timestamp >= erc.year_1_start) AND (current_timestamp < erc.year_3_start)) THEN (rdsr.vcpu_acu_hours * rp.year_1_2_pricing) ELSE 0 END) year_1_2_cost
      , rp.year_3_pricing
      , (CASE WHEN ((current_timestamp >= erc.year_3_start) AND (current_timestamp < erc.end_of_extended_support)) THEN (rdsr.vcpu_acu_hours * rp.year_3_pricing) ELSE 0 END) year_3_cost
      , rdsr.tags_json
      FROM
        ((rds_resources rdsr
      INNER JOIN regions_pricing rp ON (rdsr.region_code = rp.region_code))
      INNER JOIN engine_release_calendar erc ON (rdsr.engineversion = erc.engineversion))
      WHERE (
        (rp.rds_type = 'AmazonRDS' and rdsr.deployment_option in ('SINGLE-AZ', 'MULTI-AZ', 'MULTI-AZ-CLUSTER')) OR
        (rp.rds_type = 'Aurora' and rdsr.deployment_option in ('SERVERLESS', 'SERVERLESSV2'))
      )
    parameters:
        data_collection_database_name:
          type: athena
          query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'inventory_rds_db_instances_data'
          error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
          default: optimization_data
          description: "Enter the name of the data collection database"
          global: True
  opensearch_extended_support_view:
    dependsOn:
      tags: json
      cur2:
        - pricing_unit
        - product_product_family
        - product_servicecode
        - product['region']
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".opensearch_extended_support_view AS
      WITH
        engine_release_calendar (engineversion, start_of_extended_support, end_of_extended_support) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('elasticsearch_1.5', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_2.3', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_5.1', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_5.2', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_5.3', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_5.4', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_5.5', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_5.6', CAST('2025-11-08' AS timestamp), CAST('2028-11-07' AS timestamp))
            , ROW ('elasticsearch_6.0', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.1', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.2', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.3', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.4', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.5', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.6', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_6.7', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.1', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.2', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.3', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.4', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.5', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.6', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.7', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('elasticsearch_7.8', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_1.0', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_1.1', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_1.2', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.3', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.4', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.5', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.6', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.7', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.8', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
            , ROW ('opensearch_2.9', CAST('2025-11-08' AS timestamp), CAST('2026-11-07' AS timestamp))
         )
      )
      , instance_size_norm_factors (instance_size, normalization_factor) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('nano', 2.5E-1)
            , ROW ('micro', 5E-1)
            , ROW ('small', 1)
            , ROW ('medium', 2)
            , ROW ('large', 4)
            , ROW ('xlarge', 8)
            , ROW ('2xlarge', 16)
            , ROW ('4xlarge', 32)
            , ROW ('8xlarge', 64)
            , ROW ('9xlarge', 72)
            , ROW ('10xlarge', 80)
            , ROW ('12xlarge', 96)
            , ROW ('16xlarge', 128)
            , ROW ('18xlarge', 144)
            , ROW ('24xlarge', 192)
            , ROW ('32xlarge', 256)
         )
      )
      , regions_pricing (region_code, nih_pricing) AS (
         SELECT *
         FROM
           (
       VALUES
              ROW ('af-south-1', 8.6E-3)
            , ROW ('ap-east-1', 8.7E-3)
            , ROW ('ap-northeast-1', 8.1E-3)
            , ROW ('ap-northeast-2', 7.7E-3)
            , ROW ('ap-northeast-3', 8.1E-3)
            , ROW ('ap-south-1', 7E-3)
            , ROW ('ap-south-2', 7E-3)
            , ROW ('ap-southeast-1', 7.8E-3)
            , ROW ('ap-southeast-1', 7.4E-3)
            , ROW ('ap-southeast-2', 8.2E-3)
            , ROW ('ap-southeast-3', 7.8E-3)
            , ROW ('ap-southeast-4', 8.2E-3)
            , ROW ('ca-central-1', 7.2E-3)
            , ROW ('ca-west-2', 7.2E-3)
            , ROW ('eu-central-1', 7.6E-3)
            , ROW ('eu-central-2', 8.3E-3)
            , ROW ('eu-north-1', 6.8E-3)
            , ROW ('eu-south-1', 7.6E-3)
            , ROW ('eu-south-2', 7.2E-3)
            , ROW ('eu-west-1', 7.2E-3)
            , ROW ('eu-west-2', 7.5E-3)
            , ROW ('eu-west-3', 7.5E-3)
            , ROW ('me-central-1', 7.9E-3)
            , ROW ('me-south-1', 7.9E-3)
            , ROW ('me-west-1', 7.6E-3)
            , ROW ('sa-east-1', 1.03E-2)
            , ROW ('us-east-1', 6.5E-3)
            , ROW ('us-east-2', 6.5E-3)
            , ROW ('us-west-1', 7.7E-3)
            , ROW ('us-west-2', 6.5E-3)
            , ROW ('us-gov-east-1', 7.8E-3)
            , ROW ('us-gov-west-1', 7.8E-3)
         )
      )
      , preprocessed_opensearch_domains (payer_id, accountid, region, domainname, domainid, engineversion, collection_date, max_collection_date) AS (
         SELECT DISTINCT
           payer_id
         , accountid
         , region
         , domainname
         , domainid
         , lower(engineversion)
         , CAST("concat"("year", '-', "month", '-', "day") AS date)
         , max(CAST("concat"("year", '-', "month", '-', "day") AS date)) OVER (ORDER BY domainid ASC)
         FROM
           ${data_collection_database_name}.inventory_opensearch_domains_data
         WHERE (CAST("concat"("year", '-', "month", '-', "day") AS date) >= ("date_trunc"('day', current_date) - INTERVAL  '15' DAY))
      )
      , sanitised_opensearch_domains (payer_id, accountid, region, domainidentifier, domainname, engineversion) AS (
         SELECT DISTINCT
           payer_id
         , accountid
         , region
         , concat('domain/', domainname)
         , domainname
         , engineversion
         FROM
           preprocessed_opensearch_domains
         WHERE (collection_date = max_collection_date)
      )
      , opensearch_resources (billing_period, usage_date, payer_account_id, linked_account_id, account_name, region_code, domainidentifier, domainname, resourceid, engineversion, instance_type, instance_size, norm_factor, usage_unit, item_description, original_usage_type, tags_json, usage_amount, nihs) AS (
         SELECT
           c.bill_billing_period_start_date billing_period
         , date_trunc('day', c.line_item_usage_start_date) usage_date
         , c.bill_payer_account_id payer_account_id
         , c.line_item_usage_account_id linked_account_id
         , accmap.account_name
         , c.product['region'] region_code
         , osu.domainidentifier
         , osu.domainname
         , c.line_item_resource_id
         , osu.engineversion
         , c.product_instance_type
         , isnf.instance_size
         , isnf.normalization_factor
         , c.pricing_unit
         , c.line_item_line_item_description item_description
         , c.line_item_usage_type original_usage_type
         , ${cur_tags_json} tags_json
         , sum(c.line_item_usage_amount) usage_amount
         , sum((isnf.normalization_factor * c.line_item_usage_amount))
         FROM
           ((("${cur2_database}"."${cur2_table_name}" c
         INNER JOIN sanitised_opensearch_domains osu ON ((c.bill_payer_account_id = osu.payer_id) AND (c.line_item_usage_account_id = osu.accountid) AND (c.product['region'] = osu.region) AND (split_part(c.line_item_resource_id, ':', 6) = osu.domainidentifier)))
         INNER JOIN account_map accmap ON (c.line_item_usage_account_id = accmap.account_id))
         INNER JOIN instance_size_norm_factors isnf ON (regexp_extract(c.product_instance_type, '.+?\.(.+?)\.search', 1) = isnf.instance_size))
         WHERE (((c.bill_billing_period_start_date >= (date_trunc('month', current_timestamp) - INTERVAL  '4' MONTH)) AND (CAST(concat(c.billing_period, '-01') AS date) >= (date_trunc('month', current_date) - INTERVAL  '4' MONTH))) AND ((c.product_servicecode = 'AmazonES') AND (product_product_family = 'Amazon OpenSearch Service Instance') AND (line_item_operation = 'ESDomain')) AND (c.line_item_line_item_type IN ('DiscountedUsage', 'Usage')) AND (NOT (c.line_item_usage_type IN ('OpenSearchExtendedSupport'))))
         GROUP BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17
      )
      SELECT
        osr.billing_period
      , osr.usage_date
      , osr.payer_account_id
      , osr.linked_account_id
      , osr.account_name
      , osr.region_code
      , osr.domainname
      , osr.domainidentifier
      , osr.resourceid
      , osr.engineversion
      , osr.instance_type
      , osr.instance_size
      , osr.norm_factor
      , osr.item_description
      , osr.usage_unit
      , osr.original_usage_type
      , osr.usage_amount
      , osr.nihs
      , erc.start_of_extended_support
      , erc.end_of_extended_support
      , rp.nih_pricing
      , (osr.nihs * rp.nih_pricing) projected_extended_support_cost
      , osr.tags_json
      FROM
        ((opensearch_resources osr
      INNER JOIN regions_pricing rp ON (osr.region_code = rp.region_code))
      INNER JOIN engine_release_calendar erc ON (osr.engineversion = erc.engineversion))
    parameters:
        data_collection_database_name:
          type: athena
          query: SELECT DISTINCT table_schema FROM information_schema.columns WHERE table_name = 'inventory_opensearch_domains_data'
          error: "This means that prerequisites for the dashboard are not found. Please make sure you have the needed table: Data Collection installed, needed module is configured and Step Function runs correctly."
          default: optimization_data
          description: "Enter the name of the data collection database"
          global: True
  extended_support_tagging_view:
    dependsOn:
      tags: json
      cur2:
        - line_item_product_code
    data: |-
      CREATE OR REPLACE VIEW "${athena_database_name}".extended_support_tagging_view AS
      SELECT
        line_item_product_code
      , ${cur_tags_json} tags_json
      , count(1) rows
      FROM
        "${cur2_database}"."${cur2_table_name}" cur
      WHERE ((COALESCE(line_item_product_code, '') <> '') AND ((bill_billing_period_start_date >= (date_trunc('month', current_timestamp) - INTERVAL  '7' MONTH)) AND (CAST(concat(split_part("billing_period", '-', 1), '-', split_part("billing_period", '-', 2), '-01') AS date) >= (date_trunc('month', current_date) - INTERVAL  '7' MONTH))))
      GROUP BY 1, 2